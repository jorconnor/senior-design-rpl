{
    "cs.functions": {
        "pos": 1,
        "text": "// Copyright (C) Arctium Software.\r\n// Licensed under the MIT license. See LICENSE file in the project root for full license information.\r\n\r\nusing System;\r\nusing System.Data.Common;\r\nusing System.Linq;\r\nusing System.Reflection;\r\nusing LappaORM.Constants;\r\nusing LappaORM.Misc;\r\nusing Microsoft.Extensions.DependencyModel;\r\n\r\nnamespace LappaORM\r\n{\r\n    internal sealed class Connector\r\n    {\r\n        public string FilePath { get; set; } = null;\r\n        public string FileName { get; set; } = null;\r\n\r\n        Assembly assembly;\r\n        Type connectionType;\r\n        Type commandType;\r\n        Type parameterType;\r\n\r\n        internal void Load(DatabaseType dbType, bool loadFromFile)\r\n        {\r\n            // Use MSSQL as default.\r\n            var typeBase = \"System.Data.SqlClient.Sql\";\r\n\r\n            switch (dbType)\r\n            {\r\n                case DatabaseType.MSSql:\r\n                {\r\n                    assembly = Assembly.Load(new AssemblyName(\"System.Data.SqlClient, Version=4.3.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a\"));\r\n                    break;\r\n                }\r\n                case DatabaseType.MySql:\r\n                {\r\n                    typeBase = \"MySql.Data.MySqlClient.MySql\";\r\n\r\n                    if (loadFromFile)\r\n                        assembly = new AssemblyLoader().LoadFromAssemblyPath($\"{FilePath ?? AppContext.BaseDirectory}/{FileName ?? \"MySqlConnector.dll\"}\");\r\n                    else\r\n                    {\r\n                        var mysqlAssemblyNames = DependencyContext.Default.GetDefaultAssemblyNames().Where(asm => asm.Name.StartsWith(\"MySql.Data\") ||\r\n                                                                                                                  asm.Name.StartsWith(\"MySqlConnector\"));\r\n                        // Let's throw a type load exception if no supported MySql lib is found.\r\n                        if (mysqlAssemblyNames.Count() == 0)\r\n                            throw new TypeLoadException(\"No assembly referencing 'MySql' found.\");\r\n\r\n                        if (mysqlAssemblyNames.Count() > 1)\r\n                            throw new NotSupportedException(\"Multiple assemblies referencing 'MySql' found.\");\r\n\r\n                        assembly = Assembly.Load(mysqlAssemblyNames.First());\r\n                    }\r\n\r\n                    break;\r\n                }\r\n                case DatabaseType.SQLite:\r\n                {\r\n                    typeBase = \"Microsoft.Data.Sqlite.Sqlite\";\r\n                    assembly = Assembly.Load(new AssemblyName(\"Microsoft.Data.Sqlite, Version=1.1.0.0, Culture=neutral, PublicKeyToken=adb9793829ddae60\"));\r\n\r\n                    break;\r\n                }\r\n                default:\r\n                    break;\r\n            }\r\n\r\n            connectionType = assembly.GetType($\"{typeBase}Connection\");\r\n            commandType = assembly.GetType($\"{typeBase}Command\");\r\n            parameterType = assembly.GetType($\"{typeBase}Parameter\");\r\n\r\n            if (connectionType == null || commandType == null || parameterType == null)\r\n                throw new TypeLoadException($\"connectionType: {connectionType}, commandType: {commandType}, parameterType: {parameterType}.\");\r\n        }\r\n\r\n        public DbConnection CreateConnectionObject() => Activator.CreateInstance(connectionType) as DbConnection;\r\n        public DbCommand CreateCommandObject() => Activator.CreateInstance(commandType) as DbCommand;\r\n        public DbParameter CreateParameterObject() => Activator.CreateInstance(parameterType) as DbParameter;\r\n    }\r\n}\r\n",
        "subs": [
            {
                "cs.funcdef": {
                    "pos": 627,
                    "text": "internal void Load(DatabaseType dbType, bool loadFromFile)\r\n        {",
                    "subs": [
                        {
                            "cs.accessmod": {
                                "pos": 627,
                                "text": "internal"
                            }
                        },
                        {
                            "cs.returntype": {
                                "pos": 636,
                                "text": "void"
                            }
                        },
                        {
                            "cs.methodname": {
                                "pos": 641,
                                "text": "Load"
                            }
                        },
                        {
                            "cs.paramlist": {
                                "pos": 646,
                                "text": "DatabaseType dbType, bool loadFromFile",
                                "subs": [
                                    {
                                        "cs.param": {
                                            "pos": 646,
                                            "text": "DatabaseType dbType",
                                            "subs": [
                                                {
                                                    "cs.paramname": {
                                                        "pos": 646,
                                                        "text": "DatabaseType"
                                                    }
                                                },
                                                {
                                                    "cs.paramtype": {
                                                        "pos": 659,
                                                        "text": "dbType"
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "cs.param": {
                                            "pos": 667,
                                            "text": "bool loadFromFile",
                                            "subs": [
                                                {
                                                    "cs.paramname": {
                                                        "pos": 667,
                                                        "text": "bool"
                                                    }
                                                },
                                                {
                                                    "cs.paramtype": {
                                                        "pos": 672,
                                                        "text": "loadFromFile"
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        ]
    }
}
